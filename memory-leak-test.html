<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦ - è³½åšé¾å…‹è²“å’ªå¡”é˜²</title>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        
        #testStatus {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .test-button {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .test-button:hover {
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 10px #00ff00;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ffff;
            padding-left: 10px;
        }
        
        .warning {
            color: #ffff00;
        }
        
        .error {
            color: #ff0066;
        }
        
        .success {
            color: #00ff88;
        }
        
        iframe {
            border: 2px solid #00ffff;
            width: 100%;
            height: 600px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦å·¥å…·</h1>
    
    <div>
        <button class="test-button" onclick="startTest()">é–‹å§‹æ¸¬è©¦</button>
        <button class="test-button" onclick="stopTest()">åœæ­¢æ¸¬è©¦</button>
        <button class="test-button" onclick="checkMemory()">æª¢æŸ¥è¨˜æ†¶é«”</button>
        <button class="test-button" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
    </div>
    
    <div id="testStatus">
        <h3>æ¸¬è©¦ç‹€æ…‹</h3>
        <div id="statusLog"></div>
    </div>
    
    <iframe id="gameFrame" src="index.html"></iframe>
    
    <script>
        let testInterval = null;
        let restartCount = 0;
        let memoryReadings = [];
        const logDiv = document.getElementById('statusLog');
        
        function log(message, type = '') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function startTest() {
            log('é–‹å§‹è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦...', 'success');
            restartCount = 0;
            memoryReadings = [];
            
            // æ¯30ç§’é‡æ–°è¼‰å…¥éŠæˆ²
            testInterval = setInterval(() => {
                restartGame();
            }, 30000);
            
            // æ¯5ç§’æª¢æŸ¥è¨˜æ†¶é«”
            setInterval(() => {
                checkMemory();
            }, 5000);
        }
        
        function stopTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
                log('æ¸¬è©¦å·²åœæ­¢', 'warning');
                analyzeResults();
            }
        }
        
        function restartGame() {
            restartCount++;
            log(`ç¬¬ ${restartCount} æ¬¡é‡æ–°è¼‰å…¥éŠæˆ²...`);
            
            const frame = document.getElementById('gameFrame');
            const gameWindow = frame.contentWindow;
            
            // å˜—è©¦å‘¼å«æ¸…ç†å‡½æ•¸
            if (gameWindow.game && gameWindow.game.cleanup) {
                log('å‘¼å«éŠæˆ²æ¸…ç†å‡½æ•¸...');
                gameWindow.game.cleanup();
            }
            
            // é‡æ–°è¼‰å…¥
            frame.src = 'index.html?t=' + Date.now();
        }
        
        function checkMemory() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
                const total = Math.round(performance.memory.totalJSHeapSize / 1048576);
                const limit = Math.round(performance.memory.jsHeapSizeLimit / 1048576);
                
                memoryReadings.push({
                    time: Date.now(),
                    used: used,
                    total: total,
                    restartCount: restartCount
                });
                
                log(`è¨˜æ†¶é«”ä½¿ç”¨: ${used}MB / ${total}MB (é™åˆ¶: ${limit}MB)`);
                
                // æª¢æŸ¥è¨˜æ†¶é«”å¢é•·
                if (memoryReadings.length > 10) {
                    const recent = memoryReadings.slice(-10);
                    const oldAvg = recent.slice(0, 5).reduce((a, b) => a + b.used, 0) / 5;
                    const newAvg = recent.slice(5).reduce((a, b) => a + b.used, 0) / 5;
                    
                    if (newAvg > oldAvg * 1.2) {
                        log(`âš ï¸ åµæ¸¬åˆ°è¨˜æ†¶é«”å¢é•·: ${oldAvg.toFixed(1)}MB â†’ ${newAvg.toFixed(1)}MB`, 'warning');
                    }
                }
            } else {
                log('ç€è¦½å™¨ä¸æ”¯æ´ performance.memory API', 'error');
            }
        }
        
        function analyzeResults() {
            if (memoryReadings.length < 2) {
                log('æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•åˆ†æ', 'warning');
                return;
            }
            
            const firstReading = memoryReadings[0];
            const lastReading = memoryReadings[memoryReadings.length - 1];
            const memoryGrowth = lastReading.used - firstReading.used;
            const timeElapsed = (lastReading.time - firstReading.time) / 1000 / 60; // åˆ†é˜
            
            log('=== æ¸¬è©¦çµæœåˆ†æ ===', 'success');
            log(`æ¸¬è©¦æ™‚é•·: ${timeElapsed.toFixed(1)} åˆ†é˜`);
            log(`éŠæˆ²é‡å•Ÿæ¬¡æ•¸: ${restartCount}`);
            log(`åˆå§‹è¨˜æ†¶é«”: ${firstReading.used}MB`);
            log(`æœ€çµ‚è¨˜æ†¶é«”: ${lastReading.used}MB`);
            log(`è¨˜æ†¶é«”å¢é•·: ${memoryGrowth}MB (${(memoryGrowth / firstReading.used * 100).toFixed(1)}%)`);
            
            if (memoryGrowth < 50) {
                log('âœ… æœªç™¼ç¾æ˜é¡¯è¨˜æ†¶é«”æ´©æ¼', 'success');
            } else if (memoryGrowth < 100) {
                log('âš ï¸ ç™¼ç¾è¼•å¾®è¨˜æ†¶é«”å¢é•·ï¼Œå¯èƒ½æœ‰å°å‹æ´©æ¼', 'warning');
            } else {
                log('âŒ ç™¼ç¾åš´é‡è¨˜æ†¶é«”æ´©æ¼ï¼', 'error');
            }
        }
        
        function clearLogs() {
            logDiv.innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'success');
        }
        
        // åˆå§‹æª¢æŸ¥
        log('è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦å·¥å…·å·²è¼‰å…¥', 'success');
        log('é»æ“Š"é–‹å§‹æ¸¬è©¦"æŒ‰éˆ•é–‹å§‹è‡ªå‹•åŒ–æ¸¬è©¦');
        
        // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
        if (!performance.memory) {
            log('âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ performance.memory API', 'warning');
            log('è«‹ä½¿ç”¨ Chrome ä¸¦åŠ ä¸Š --enable-precise-memory-info åƒæ•¸å•Ÿå‹•', 'warning');
        }
    </script>
</body>
</html>